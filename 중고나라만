import tkinter as tk
from tkinter import ttk
from joonggonara_crawler import JoongonaraCrawler
from bs4 import BeautifulSoup
import requests

class SearchApp:
    def __init__(self, master):
        self.master = master
        self.joongonara_crawler = JoongonaraCrawler()
        
        master.title("중고거래 도우미")

        self.frame = ttk.Frame(master, padding="10")
        self.frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        self.entry = ttk.Entry(self.frame, width=40)
        self.entry.grid(row=0, column=0, padx=5, pady=5)

        self.search_button = ttk.Button(self.frame, text="검색", command=self.search)
        self.search_button.grid(row=0, column=1, padx=5, pady=5)

        self.result_text = tk.Text(self.frame, height=20, width=60)
        self.result_text.grid(row=1, column=0, columnspan=2, padx=5, pady=5)

        master.protocol("WM_DELETE_WINDOW", self.on_closing)

    def search(self):
        keyword = self.entry.get()
        self.result_text.delete('1.0', tk.END)
        self.result_text.insert(tk.END, "검색 중...\n")

        self.master.after(100, self.update_results, keyword)

    def update_results(self, keyword):
        results_joongonara = self.joongonara_crawler.crawl(keyword)
        
        self.result_text.delete('1.0', tk.END)
        self.result_text.insert(tk.END, "중고나라 결과:\n")
        for title, price in results_joongonara:
            self.result_text.insert(tk.END, f"{title} - {price}\n")
        
        self.result_text.insert(tk.END, "\n\n중고나라 상품명:\n")
        # 중고나라 사이트에서 상품명 가져오기
        header={'user_agent':'Mozilla/5.0'}
        response=requests.get("https://web.joongna.com/",headers=header)
        html = response.text
        soup = BeautifulSoup(html, 'html.parser')
        titles= soup.select('.line-clamp-2')
        for title in titles:
            self.result_text.insert(tk.END, title.text.strip() + "\n")
       
    def on_closing(self):
        self.joongonara_crawler.close()
        self.master.destroy()

if __name__ == "__main__":
    root = tk.Tk()
    app = SearchApp(root)
    root.mainloop()
